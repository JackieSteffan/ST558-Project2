---
title: "ST 558 Project 2"
author: "Hannah Park"
date: "10/15/2020"
output: rmarkdown::github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(knitr)
library(tidyverse)
library(ggplot2)
library(GGally)
library(corrplot)
library(expss)
library(gridExtra)
library(caret)
```

# Introduction  

You should have an introduction section that briefly describes the data and the variables you have to work with (no need to discuss all of them, just the ones you want to use). **If you are analyzing the bike share data, do not use the casual and registered variables to do any modeling!**  

You should also mention the purpose of your analysis and the methods youâ€™ll use (no need to detail them here) for analysis.


# Data  
```{r, message = FALSE, warning = FALSE}
# Read in data
url <- "https://archive.ics.uci.edu/ml/machine-learning-databases/00275/Bike-Sharing-Dataset.zip"
download.file(url, "Bike-Sharing-Dataset.zip")

unzip("Bike-Sharing-Dataset.zip", exdir = "./Data")
df.bike <- read_csv("/Data/day.csv") %>%
  select(-instant, -casual, -registered) %>%
  mutate(dayofweek = dplyr::recode(weekday,
                            `0` = "Sunday",
                            `1` = "Monday",
                            `2` = "Tuesday",
                            `3` = "Wednesday",
                            `4` = "Thursday",
                            `5` = "Friday",
                            `6` = "Saturday")) %>%
  #Combine variables temp and atemp 
  mutate(avgTemp = (temp+atemp)/2)

df.bike.day <- df.bike %>%
  filter(weekday == 1)

#Randomply sample from the data 
#Form training and test sets
train <- sample(1:nrow(df.bike.day), size = nrow(df.bike.day)*0.7)
test <- dplyr::setdiff(1:nrow(df.bike.day), train)
df.train <- df.bike.day[train, ]
df.test <- df.bike.day[test, ]
```

# Summarizations  
## Full Data  

Original data is used for full data exploratory analysis.  

#### Figure 1. Correlation plot  
```{r correlation-plot, fig.cap = "Correlation Plot"}
corrplot(cor(df.bike[,2:13]))
```

#### Table 1. Qualitative variables: Contingency tables  
```{r}
df.tbl <- apply_labels(df.bike,
                       holiday = "Holiday",
                       holiday = c("No" = 0,
                                   "Yes" = 1),
                       weathersit = "Weather",
                       weathersit = c("Good" = 1,
                                      "Moderate" = 2,
                                      "Bad" = 3,
                                      "Extreme" = 4),
                       dayofweek = "Day of Week")
attach(df.tbl)
cro_cases(list(holiday, weathersit), dayofweek,
          total_row_position = "none")
detach(df.tbl)
```

#### Figure 2. Histograms of quantitative variables    
```{r}
df.bike %>%
  gather(avgTemp, hum, windspeed, key = "var", value = "value") %>%
  mutate(var = factor(var, levels = c("hum", "avgTemp", "windspeed"))) %>%
  ggplot(aes(x = value)) +
  geom_histogram(bins = 50) +
  facet_wrap(~var, scales = "free", nrow = 2) 
```

#### Figure 3. Scatterplot of response variable(cnt) over days    
```{r}
ggplot(df.bike, aes(x = dteday, y = cnt)) +
  geom_point(aes(colour = factor(holiday)))
```

## Specific Day of the Week Data  

Training data is used.  

#### Table 2. Qualitative variables: Contingency tables  
```{r}
df.tbl.train <- apply_labels(df.train,
                       holiday = "Holiday",
                       holiday = c("No" = 0,
                                   "Yes" = 1),
                       weathersit = "Weather",
                       weathersit = c("Good" = 1,
                                      "Moderate" = 2,
                                      "Bad" = 3,
                                      "Extreme" = 4),
                       dayofweek = "Day of Week")
attach(df.tbl.train)
cro_cases(weathersit, mnth,
          total_row_position = "none")
detach(df.tbl.train)

```

#### Table 3. Quantitative variables: Summary statistics  
```{r}
df.tbl.train %>%
  tab_cells(avgTemp, hum, windspeed) %>%
  tab_cols(mnth) %>%
  tab_stat_fun(Minimum = w_min, Median = w_median, 
               Mean = w_mean, Max = w_max) %>%
  tab_pivot()
```

#### Figure 4. Qualitative variables: Boxplots   
```{r}
boxplot1 <- df.train %>%
  ggplot(aes(x = factor(mnth), y = cnt)) +
  geom_boxplot()

boxplot2 <- df.train %>%
  ggplot(aes(x = factor(weathersit), y = cnt)) +
  geom_boxplot() 

boxplot3 <- df.train %>%
  ggplot(aes(x = factor(holiday), y = cnt)) +
  geom_boxplot() 

boxplot4 <- df.train %>%
  ggplot(aes(x = factor(yr), y = cnt)) +
  geom_boxplot()

grid.arrange(boxplot4, boxplot1, boxplot3, boxplot2)
```

#### Figure 5. Quantitative variables: Scatterplots    
```{r}
df.train %>%
  gather(avgTemp, hum, windspeed, key = "var", value = "value") %>%
  mutate(var = factor(var, levels = c("hum", "avgTemp", "windspeed"))) %>%
  ggplot(aes(x = value, y = cnt, color = factor(yr))) +
  geom_point() +
  geom_smooth(aes(group = factor(yr))) +
  facet_wrap(~var, scales = "free", nrow = 2) 
```

# Modeling  

## Tree-based Model  
```{r}
treeFit <- train(cnt ~ yr + mnth + holiday + weathersit + avgTemp + hum + windspeed, data = df.train,
                  method = "rpart",
                  trControl = trainControl(method = "LOOCV")
                  )
treeFit$results

treePred <- predict(treeFit, newdata = df.test)
treeRMSE <- sqrt(mean((treePred-df.test$cnt)^2))
```




## Boosted Tree Model  
```{r}
boostFit <- train(cnt ~ yr + mnth + holiday + weathersit + avgTemp + hum + windspeed, data = df.train,
                  method = "gbm",
                  trControl = trainControl(method = "cv", number = 10),
                  preProcess = c("center", "scale"),
                  verbose = FALSE)
boostFit$results

boostPred <- predict(boostFit, newdata = df.test)
boostRMSE <- sqrt(mean((boostPred-df.test$cnt)^2))
```

# Model Comparison  
```{r}
tbl.rmse <- rbind.data.frame("tree" = treeRMSE, "boost" = boostRMSE)
colnames(tbl.rmse) <- "RMSE"
rownames(tbl.rmse) <- c("Reg. Tree", "Boost Tree")
kable(tbl.rmse, caption = "Comparison of Models' RMSE")
```





























